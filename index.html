<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelMate V17</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --espresso: #4E342E; --cocoa: #6D4C41; --biscuit: #D7CCC8; --cream: #FDFBF9; --mascarpone: #FFFFFF; }
        body { font-family: -apple-system, sans-serif; background-color: var(--cream); color: var(--espresso); padding-top: env(safe-area-inset-top); font-size: 16px; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .day-tab.active { background: var(--espresso); color: var(--mascarpone); }
        .day-tab { background: var(--biscuit); color: var(--cocoa); transition: all 0.2s; }
        .view-content { display: none; }
        .view-content.active { display: block; }
        .timeline-line::before { content: ''; position: absolute; left: 28px; top: 0; bottom: 0; width: 2px; background: var(--biscuit); z-index: 0; }
        input, select, textarea { border: 1.5px solid var(--biscuit) !important; background: var(--mascarpone) !important; color: var(--espresso) !important; border-radius: 14px !important; padding: 12px 16px !important; width: 100%; }
        .btn-primary { background: var(--espresso); color: var(--mascarpone); }
        .sub-nav-btn { color: var(--biscuit); }
        .sub-nav-btn.active { color: var(--espresso); }
    </style>
</head>
<body class="pb-32">

    <div id="view-home" class="p-8">
        <header class="mb-12 text-center">
            <h1 class="text-4xl font-serif font-bold tracking-widest uppercase">TravelMate</h1>
            <p class="text-xs text-stone-400 mt-2 tracking-[0.2em] uppercase italic">Essence of Journey</p>
        </header>
        <div id="tripList" class="space-y-6"></div>
        <button onclick="showCreateModal()" class="fixed bottom-10 right-8 btn-primary w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-2xl z-50"><i class="fas fa-plus"></i></button>
    </div>

    <div id="view-detail" class="hidden min-h-screen">
        <header class="bg-stone-50 p-6 sticky top-0 z-40 border-b border-stone-100">
            <div class="flex justify-between items-center mb-6">
                <button onclick="goHome()" class="p-2 text-stone-500"><i class="fas fa-chevron-left text-xl"></i></button>
                <h2 id="currentTripTitle" class="text-lg font-black truncate px-4 flex-1 text-center"></h2>
                <div class="flex gap-2">
                    <button onclick="exportTripData()" class="p-2 text-stone-500"><i class="fas fa-share-nodes"></i></button>
                    <button onclick="deleteCurrentTrip()" class="p-2 text-stone-300"><i class="fas fa-trash-can"></i></button>
                </div>
            </div>
            <div id="daySelector" class="flex overflow-x-auto space-x-4 no-scrollbar pb-2"></div>
        </header>

        <main class="p-6">
            <div id="sub-itinerary" class="view-content active relative timeline-line">
                <div id="itineraryItems" class="space-y-10 relative z-10"></div>
                <button onclick="showAddSpotModal()" class="mt-14 w-full py-5 border-2 border-dashed border-stone-300 rounded-2xl text-stone-400 text-sm font-black uppercase">+ New Schedule</button>
            </div>

            <div id="sub-wallet" class="view-content space-y-6">
                <div class="bg-white p-6 rounded-3xl border border-stone-50 shadow-sm space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input id="expAmount" type="number" placeholder="0.00">
                        <select id="expCurrency">
                            <option value="TWD">台幣 TWD</option>
                            <option value="JPY">日幣 JPY</option>
                            <option value="KRW">韓元 KRW</option>
                            <option value="USD">美金 USD</option>
                            <option value="EUR">歐元 EUR</option>
                            <option value="GBP">英鎊 GBP</option>
                            <option value="AUD">澳幣 AUD</option>
                            <option value="CHF">瑞士法郎 CHF</option>
                            <option value="CNY">人民幣 CNY</option>
                            <option value="HKD">港幣 HKD</option>
                            <option value="THB">泰銖 THB</option>
                            <option value="SGD">新加坡幣 SGD</option>
                            <option value="CZK">捷克克朗 CZK</option>
                            <option value="DKK">丹麥克朗 DKK</option>
                            <option value="HUF">匈牙利福林 HUF</option>
                        </select>
                    </div>
                    <input id="expNote" type="text" placeholder="品項名稱">
                    <button onclick="addExpense()" class="w-full btn-primary py-4 rounded-2xl font-black uppercase">Save Expense</button>
                    
                    <div class="pt-4 border-t border-stone-100 space-y-2">
                        <div class="flex justify-between items-center px-2">
                            <span class="text-[10px] font-bold text-stone-400 uppercase">Total (TWD)</span>
                            <span id="totalExpense" class="text-xl font-serif italic font-bold">NT$ 0</span>
                        </div>
                        <div id="currencyBreakdown" class="px-2 space-y-1">
                            </div>
                    </div>
                </div>
                <div id="expenseList" class="space-y-3"></div>
            </div>

            <div id="sub-notes" class="view-content">
                <textarea id="tripNotes" class="w-full h-[60vh] p-4 text-lg border-none focus:ring-0" placeholder="Notes..." oninput="saveAll()"></textarea>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 pb-10 flex justify-around z-50">
            <button onclick="switchSubTab('itinerary')" class="sub-nav-btn active flex-1 flex flex-col items-center"><i class="fas fa-calendar-alt text-2xl"></i><span class="text-[9px] mt-1 font-bold">PLAN</span></button>
            <button onclick="switchSubTab('wallet')" class="sub-nav-btn flex-1 flex flex-col items-center"><i class="fas fa-receipt text-2xl"></i><span class="text-[9px] mt-1 font-bold">COST</span></button>
            <button onclick="switchSubTab('notes')" class="sub-nav-btn flex-1 flex flex-col items-center"><i class="fas fa-pen-nib text-2xl"></i><span class="text-[9px] mt-1 font-bold">NOTE</span></button>
        </nav>
    </div>

    <div id="modal-create" class="hidden fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-8">
        <div class="bg-white w-full rounded-[2.5rem] p-10 space-y-4">
            <h3 class="font-bold text-center uppercase">New Journey</h3>
            <input id="newTripName" type="text" placeholder="Trip Name">
            <input id="newTripStart" type="date">
            <input id="newTripEnd" type="date">
            <button onclick="createNewTrip()" class="w-full btn-primary py-4 rounded-2xl font-black">START</button>
            <button onclick="hideCreateModal()" class="w-full text-stone-400 text-xs font-bold text-center w-full block">CANCEL</button>
        </div>
    </div>

    <div id="modal-add-spot" class="hidden fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-[101] flex items-center justify-center p-8">
        <div class="bg-white w-full rounded-[2.5rem] p-10 space-y-4">
            <h3 id="spotModalTitle" class="font-bold text-center uppercase">Add Spot</h3>
            <input id="spotTime" type="time">
            <input id="spotName" type="text" placeholder="Activity">
            <div class="flex gap-4">
                <button onclick="hideAddSpotModal()" class="flex-1 text-stone-400 text-sm">Cancel</button>
                <button onclick="saveNewSpot()" class="flex-1 btn-primary py-4 rounded-2xl font-black">OK</button>
            </div>
            <button id="btnDeleteSpot" onclick="deleteSpot()" class="hidden w-full text-red-300 text-xs mt-2">DELETE</button>
        </div>
    </div>

    <script>
        // 設定各幣別對台幣匯率 (大約值)
        const RATES = { 
            TWD: 1, JPY: 0.21, KRW: 0.024, USD: 32.5, EUR: 35.2, GBP: 41.2, 
            AUD: 21.5, CHF: 37.8, CNY: 4.5, HKD: 4.1, THB: 0.9, SGD: 24.2,
            CZK: 1.4, DKK: 4.7, HUF: 0.09 
        };

        let allTrips = JSON.parse(localStorage.getItem('TravelMate_V17')) || [];
        let currentTripIndex = null;
        let selectedDayIndex = 0;
        let editingSpotIndex = null;

        function renderTripList() {
            const list = document.getElementById('tripList');
            if(!list) return;
            list.innerHTML = allTrips.length === 0 ? '<p class="text-center text-stone-300 py-32 uppercase tracking-widest">No Trips</p>' : 
            allTrips.map((t, i) => `
                <div onclick="showDetail(${i})" class="bg-white p-6 rounded-[2rem] shadow-sm flex justify-between items-center border border-stone-50 active:scale-95 transition-transform">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-stone-100 rounded-xl flex items-center justify-center font-bold text-stone-400">${t.name ? t.name[0] : '?'}</div>
                        <div><h3 class="font-black text-stone-800">${t.name}</h3><p class="text-[10px] text-stone-400 font-mono">${t.start} - ${t.end}</p></div>
                    </div>
                    <i class="fas fa-chevron-right text-stone-200"></i>
                </div>
            `).join('');
        }

        function showDetail(idx) {
            currentTripIndex = idx;
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            renderTripDetail();
        }

        function renderTripDetail() {
            const trip = allTrips[currentTripIndex];
            if(!trip) return goHome();
            document.getElementById('currentTripTitle').innerText = trip.name;
            document.getElementById('tripNotes').value = trip.notes || "";

            const daySelector = document.getElementById('daySelector');
            daySelector.innerHTML = (trip.dailyItinerary || []).map((d, i) => `
                <button onclick="selectedDayIndex=${i}; renderTripDetail()" class="day-tab flex-shrink-0 min-w-[70px] p-3 rounded-2xl text-center ${selectedDayIndex === i ? 'active' : ''}">
                    <div class="text-[10px] opacity-70 mb-1 font-bold">${['SUN','MON','TUE','WED','THU','FRI','SAT'][new Date(d.date).getDay()]}</div>
                    <div class="text-sm font-black">${d.date.substring(5).replace('-','/')}</div>
                </button>
            `).join('');

            const itItems = document.getElementById('itineraryItems');
            const items = (trip.dailyItinerary[selectedDayIndex].items || []).sort((a,b) => a.time.localeCompare(b.time));
            itItems.innerHTML = items.length === 0 ? '<p class="text-center text-stone-400 py-20 uppercase text-xs tracking-widest">Plan Empty</p>' :
            items.map((s, idx) => `
                <div class="flex gap-4 relative">
                    <div onclick="editSpot(${idx})" class="z-10 bg-stone-800 w-12 h-12 rounded-full border-4 border-[#FDFBF9] shadow-sm flex-shrink-0 flex items-center justify-center text-white text-[10px] font-black">${s.time}</div>
                    <div class="bg-white p-4 rounded-2xl flex-1 flex justify-between items-center shadow-sm border border-stone-50">
                        <div onclick="editSpot(${idx})" class="flex-1"><h3 class="font-bold text-stone-800">${s.name}</h3><p class="text-[10px] text-blue-500 font-bold">${s.weather || ''}</p></div>
                        <button onclick="openNav('${s.name}')" class="w-8 h-8 rounded-full border border-stone-100 flex items-center justify-center text-stone-400"><i class="fas fa-location-arrow text-xs"></i></button>
                    </div>
                </div>
            `).join('');
            updateTotal();
        }

        function addExpense() {
            const amount = parseFloat(document.getElementById('expAmount').value);
            const curr = document.getElementById('expCurrency').value;
            const note = document.getElementById('expNote').value;
            if (amount && note) {
                allTrips[currentTripIndex].expenses.unshift({ 
                    amount, curr, note, 
                    twd: Math.round(amount * (RATES[curr] || 1)) 
                });
                document.getElementById('expAmount').value = ''; 
                document.getElementById('expNote').value = '';
                saveAll(); renderTripDetail();
            }
        }

        function updateTotal() {
            let totalTWD = 0;
            let foreignTotals = {}; // 用於存各幣別總和
            const trip = allTrips[currentTripIndex];
            const list = document.getElementById('expenseList');
            
            list.innerHTML = (trip.expenses || []).map(ex => {
                totalTWD += ex.twd;
                // 統計外幣
                if(ex.curr !== 'TWD') {
                    foreignTotals[ex.curr] = (foreignTotals[ex.curr] || 0) + ex.amount;
                }

                return `<div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-stone-50">
                    <p class="font-bold text-stone-700 text-sm flex-1 truncate pr-4">${ex.note}</p>
                    <div class="text-right">
                        <p class="text-[9px] text-stone-400 font-mono uppercase">${ex.amount} ${ex.curr}</p>
                        <p class="text-sm font-black">NT$ ${ex.twd.toLocaleString()}</p>
                    </div>
                </div>`;
            }).join('');

            // 更新台幣總額
            document.getElementById('totalExpense').innerText = `NT$ ${totalTWD.toLocaleString()}`;

            // 更新外幣統計顯示
            const breakdown = document.getElementById('currencyBreakdown');
            const foreignKeys = Object.keys(foreignTotals);
            if(foreignKeys.length > 0) {
                breakdown.innerHTML = foreignKeys.map(k => `
                    <div class="flex justify-between text-[11px] font-mono text-stone-500">
                        <span>${k} SUB-TOTAL:</span>
                        <span class="font-bold">${foreignTotals[k].toLocaleString()} ${k}</span>
                    </div>
                `).join('');
            } else {
                breakdown.innerHTML = '';
            }
        }

        function openNav(dest) { event.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`, '_blank'); }
        async function saveNewSpot() {
            const time = document.getElementById('spotTime').value;
            const name = document.getElementById('spotName').value;
            if(!time || !name) return;
            if(editingSpotIndex !== null) {
                allTrips[currentTripIndex].dailyItinerary[selectedDayIndex].items[editingSpotIndex] = { ...allTrips[currentTripIndex].dailyItinerary[selectedDayIndex].items[editingSpotIndex], time, name };
            } else {
                const weather = await fetchWeather();
                allTrips[currentTripIndex].dailyItinerary[selectedDayIndex].items.push({ time, name, weather });
            }
            saveAll(); hideAddSpotModal(); renderTripDetail();
        }
        function editSpot(idx) {
            editingSpotIndex = idx;
            const s = allTrips[currentTripIndex].dailyItinerary[selectedDayIndex].items[idx];
            document.getElementById('spotModalTitle').innerText = "Edit Spot";
            document.getElementById('spotTime').value = s.time;
            document.getElementById('spotName').value = s.name;
            document.getElementById('btnDeleteSpot').classList.remove('hidden');
            showAddSpotModal();
        }
        function createNewTrip() {
            const name = document.getElementById('newTripName').value;
            const start = document.getElementById('newTripStart').value;
            const end = document.getElementById('newTripEnd').value;
            if(!name || !start || !end) return;
            const dateArray = []; let dt = new Date(start);
            while(dt <= new Date(end)) { dateArray.push(new Date(dt).toISOString().split('T')[0]); dt.setDate(dt.getDate()+1); }
            allTrips.push({ name, start, end, dailyItinerary: dateArray.map(d=>({date: d, items: []})), expenses: [], notes: "" });
            saveAll(); hideCreateModal(); renderTripList();
        }
        async function fetchWeather() {
            return new Promise(r => {
                navigator.geolocation.getCurrentPosition(async p => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`);
                        const d = await res.json(); r(`${Math.round(d.current_weather.temperature)}°C`);
                    } catch { r(""); }
                }, () => r(""), {timeout: 2000});
            });
        }
        function saveAll() { localStorage.setItem('TravelMate_V17', JSON.stringify(allTrips)); }
        function goHome() { currentTripIndex = null; document.getElementById('view-home').classList.remove('hidden'); document.getElementById('view-detail').classList.add('hidden'); renderTripList(); }
        function showCreateModal() { document.getElementById('modal-create').classList.remove('hidden'); }
        function hideCreateModal() { document.getElementById('modal-create').classList.add('hidden'); }
        function showAddSpotModal() { document.getElementById('modal-add-spot').classList.remove('hidden'); }
        function hideAddSpotModal() { document.getElementById('modal-add-spot').classList.add('hidden'); editingSpotIndex = null; document.getElementById('btnDeleteSpot').classList.add('hidden'); }
        function deleteSpot() { if(confirm("Delete?")) { allTrips[currentTripIndex].dailyItinerary[selectedDayIndex].items.splice(editingSpotIndex, 1); saveAll(); hideAddSpotModal(); renderTripDetail(); } }
        function deleteCurrentTrip() { if(confirm("Delete Trip?")) { allTrips.splice(currentTripIndex, 1); saveAll(); goHome(); } }
        function switchSubTab(t) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.getElementById('sub-' + t).classList.add('active');
            document.querySelectorAll('.sub-nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        function exportTripData() {
            const trip = allTrips[currentTripIndex];
            let t = `☕️ ${trip.name}\n\n`;
            trip.dailyItinerary.forEach(d => { t += `[ ${d.date} ]\n`; (d.items||[]).forEach(i => t += `• ${i.time} ${i.name}\n`); t += `\n`; });
            navigator.clipboard.writeText(t).then(() => alert("COPIED"));
        }
        window.onload = renderTripList;
    </script>
</body>
</html>
